---

- name: install grid
  environment: "{{ ora_user_env }}"
  shell: |
    su - {{ oracle_user }} -c "{{ oracle_tmp }}/grid/runInstaller -silent -force -ignorePrereq -ignoreSysPreReqs -responseFile {{ oracle_tmp }}/grid_install.rsp" 2>{{ oracle_tmp }}/grid_stderr.err >{{ oracle_tmp }}/grid_stdout.out &
    sleep 30
    while true
    do 
      c=$(ps -ef | grep -v grep | grep grid_install.rsp | grep java | wc -l)
      [ $c -eq 0 ] && break
      sleep 10
    done
  args:
    executable: /bin/bash
    creates: "{{ oracle_grid_home }}/cfgtoollogs/configToolAllCommands"
  when: inventory_hostname == master_node

## TODO: Dynamically pull which scripts need to run.

# - name: wait for orainstRoot.sh
#   wait_for: 
#     path: "{{ oracle_base }}/oraInventory/orainstRoot.sh"

- name: general oracle post-installation
  command: "{{ oracle_base }}/oraInventory/orainstRoot.sh"
  ignore_errors: yes
  when: grid_install_mode != "UPGRADE"

# - name: wait for root.sh
#   wait_for: 
#     path: "{{ oracle_grid_home }}/root.sh"

- name: db-specific oracle post-installation (Master)
  command: "{{ oracle_grid_home }}/root.sh"
  ignore_errors: yes
  when: inventory_hostname == master_node
  tags: root_script

- name: db-specific oracle post-installation (Remaining)
  command: "{{ oracle_grid_home }}/root.sh"
  when: 
  - inventory_hostname != master_node
  - inventory_hostname == item
  loop: "{{ cluster_nodes }}"
  tags: root_script

- name: run grid configTool
  environment: "{{ ora_user_env }}"
  shell: |
    su - {{ oracle_user }} -c "{{ oracle_grid_home }}/cfgtoollogs/configToolAllCommands RESPONSE_FILE={{ oracle_tmp }}/grid_configTool.rsp" 2>{{ oracle_tmp }}/config_stderr.err >{{ oracle_tmp }}/config_stdout.out &
    sleep 30
    while true
    do 
      c=$(ps -ef | grep -v grep | grep grid_configTool.rsp | grep java | wc -l)
      [ $c -eq 0 ] && break
      sleep 10
    done
  args:
    executable: /bin/bash
  when: inventory_hostname == master_node